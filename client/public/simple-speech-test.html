<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Interface - AIVoiceTranslator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
        }
        h1, h2 {
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .status {
            margin-bottom: 10px;
            font-weight: bold;
        }
        .status.active {
            color: green;
        }
        .status.inactive {
            color: #666;
        }
        .transcript {
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .final {
            color: black;
        }
        .interim {
            color: gray;
            font-style: italic;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.stop {
            background-color: #f44336;
        }
        .error {
            color: red;
            margin-top: 10px;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffcdd2;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .direct-input {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }
        .direct-input input {
            width: calc(100% - 110px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #send-text {
            background-color: #2196F3;
        }
        .debug {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .language-categories {
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .language-category {
            border-bottom: 1px solid #e0e0e0;
        }
        .language-category:last-child {
            border-bottom: none;
        }
        .category-header {
            padding: 10px 15px;
            background-color: #f8f9fa;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-header:hover {
            background-color: #e9ecef;
        }
        .category-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 5px;
            padding: 10px;
            background-color: #ffffff;
        }
        .language-option {
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .language-option:hover {
            background-color: #f1f1f1;
        }
        .language-option.selected {
            background-color: #e3f2fd;
            color: #1565c0;
            font-weight: 500;
        }
        .chevron {
            transition: transform 0.3s;
        }
        .collapsed .chevron {
            transform: rotate(-90deg);
        }
        .mic-icon {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-right: 5px;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .warning {
            background-color: #fff8e1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffe082;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Teacher Interface</h1>
    
    <div class="warning">
        <strong>Browser Support:</strong> Speech Recognition works best in Chrome and Edge. Firefox and Safari might have limited support.
    </div>
    
    <p style="text-align: center; margin-bottom: 20px;">
        <a href="/" style="color: #3498db; text-decoration: none;">← Back to Home</a>
    </p>

    <div class="container">
        <div class="card">
            <h2>Speech Recognition</h2>
            <div id="status" class="status inactive">Status: Not Recording</div>
            <div id="error-container"></div>
            <h3>Current Speech:</h3>
            <div id="transcript" class="transcript">
                <span class="final" id="final-transcript"></span>
                <span class="interim" id="interim-transcript"></span>
            </div>
            
            <div class="controls">
                <button id="start-btn">Start Recording</button>
                <button id="stop-btn" class="stop" disabled>Stop Recording</button>
                <button id="clear-btn">Clear Transcript</button>
                <select id="language-select">
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="es-ES">Spanish</option>
                    <option value="fr-FR">French</option>
                    <option value="de-DE">German</option>
                    <option value="zh-CN">Chinese (Simplified)</option>
                    <option value="zh-TW">Chinese (Traditional)</option>
                    <option value="ja-JP">Japanese</option>
                    <option value="ko-KR">Korean</option>
                    <option value="ru-RU">Russian</option>
                    <option value="it-IT">Italian</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="pt-PT">Portuguese (Portugal)</option>
                    <option value="nl-NL">Dutch</option>
                    <option value="ar-SA">Arabic</option>
                    <option value="hi-IN">Hindi</option>
                    <option value="id-ID">Indonesian</option>
                    <option value="th-TH">Thai</option>
                    <option value="vi-VN">Vietnamese</option>
                    <option value="tr-TR">Turkish</option>
                    <option value="pl-PL">Polish</option>
                    <option value="he-IL">Hebrew</option>
                    <option value="sv-SE">Swedish</option>
                    <option value="cs-CZ">Czech</option>
                    <option value="da-DK">Danish</option>
                    <option value="fi-FI">Finnish</option>
                    <option value="el-GR">Greek</option>
                    <option value="hu-HU">Hungarian</option>
                    <option value="ro-RO">Romanian</option>
                    <option value="no-NO">Norwegian</option>
                </select>
            </div>
            
            <h3>Select Language by Region:</h3>
            <div class="language-categories">
                <div class="language-category">
                    <div class="category-header" data-category="european">
                        <span>European Languages</span>
                        <span class="chevron">▼</span>
                    </div>
                    <div class="category-content" id="european-languages">
                        <div class="language-option" data-lang="en-US">English (US)</div>
                        <div class="language-option" data-lang="en-GB">English (UK)</div>
                        <div class="language-option" data-lang="es-ES">Spanish</div>
                        <div class="language-option" data-lang="fr-FR">French</div>
                        <div class="language-option" data-lang="de-DE">German</div>
                        <div class="language-option" data-lang="it-IT">Italian</div>
                        <div class="language-option" data-lang="pt-PT">Portuguese (EU)</div>
                        <div class="language-option" data-lang="nl-NL">Dutch</div>
                        <div class="language-option" data-lang="ru-RU">Russian</div>
                        <div class="language-option" data-lang="pl-PL">Polish</div>
                        <div class="language-option" data-lang="sv-SE">Swedish</div>
                        <div class="language-option" data-lang="cs-CZ">Czech</div>
                        <div class="language-option" data-lang="da-DK">Danish</div>
                        <div class="language-option" data-lang="fi-FI">Finnish</div>
                        <div class="language-option" data-lang="el-GR">Greek</div>
                        <div class="language-option" data-lang="hu-HU">Hungarian</div>
                        <div class="language-option" data-lang="ro-RO">Romanian</div>
                        <div class="language-option" data-lang="no-NO">Norwegian</div>
                    </div>
                </div>
                
                <div class="language-category">
                    <div class="category-header" data-category="asian">
                        <span>Asian Languages</span>
                        <span class="chevron">▼</span>
                    </div>
                    <div class="category-content" id="asian-languages">
                        <div class="language-option" data-lang="zh-CN">Chinese (Simplified)</div>
                        <div class="language-option" data-lang="zh-TW">Chinese (Traditional)</div>
                        <div class="language-option" data-lang="ja-JP">Japanese</div>
                        <div class="language-option" data-lang="ko-KR">Korean</div>
                        <div class="language-option" data-lang="hi-IN">Hindi</div>
                        <div class="language-option" data-lang="th-TH">Thai</div>
                        <div class="language-option" data-lang="vi-VN">Vietnamese</div>
                        <div class="language-option" data-lang="id-ID">Indonesian</div>
                    </div>
                </div>
                
                <div class="language-category">
                    <div class="category-header" data-category="middle-east">
                        <span>Middle Eastern & African</span>
                        <span class="chevron">▼</span>
                    </div>
                    <div class="category-content" id="middle-east-languages">
                        <div class="language-option" data-lang="ar-SA">Arabic</div>
                        <div class="language-option" data-lang="he-IL">Hebrew</div>
                        <div class="language-option" data-lang="tr-TR">Turkish</div>
                    </div>
                </div>
                
                <div class="language-category">
                    <div class="category-header" data-category="americas">
                        <span>Americas</span>
                        <span class="chevron">▼</span>
                    </div>
                    <div class="category-content" id="americas-languages">
                        <div class="language-option" data-lang="pt-BR">Portuguese (Brazil)</div>
                        <div class="language-option" data-lang="es-MX">Spanish (Mexico)</div>
                        <div class="language-option" data-lang="fr-CA">French (Canada)</div>
                        <div class="language-option" data-lang="en-CA">English (Canada)</div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="card">
            <h2>WebSocket Status</h2>
            <div id="ws-status">Connecting automatically...</div>
            <div id="session-id">Session ID: None</div>
            <div id="messages"></div>
        </div>
    </div>
    
    <div class="debug">
        <h3>Debug Information:</h3>
        <div id="debug-log"></div>
    </div>
    
    <script>
        // Debug logging
        function log(message) {
            const debugLog = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `<div>${timestamp}: ${message}</div>`;
            console.log(message);
        }
        
        // Speech Recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = '<div class="error">Speech Recognition is not supported in this browser. Please try Chrome or Edge.</div>';
            document.getElementById('start-btn').disabled = true;
        }
        
        let recognition;
        let finalTranscript = '';
        let isRecording = false;
        
        function initRecognition() {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.lang = document.getElementById('language-select').value;
            
            recognition.onstart = function() {
                log('Speech recognition started');
                isRecording = true;
                updateStatus(true);
            };
            
            recognition.onend = function() {
                log('Speech recognition ended');
                
                // If we didn't explicitly stop, try to restart
                if (isRecording) {
                    log('Restarting recognition...');
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            log('Error restarting recognition: ' + e.message);
                            isRecording = false;
                            updateStatus(false);
                        }
                    }, 500);
                } else {
                    updateStatus(false);
                }
            };
            
            recognition.onresult = function(event) {
                log('Got speech recognition result');
                
                // Create interim transcript
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                        
                        // Send to WebSocket if connected
                        if (isConnected) {
                            sendTranscription(event.results[i][0].transcript);
                        }
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                // Update display
                document.getElementById('final-transcript').innerText = finalTranscript;
                document.getElementById('interim-transcript').innerText = interimTranscript;
            };
            
            recognition.onerror = function(event) {
                const errorContainer = document.getElementById('error-container');
                log('Speech recognition error: ' + event.error);
                
                let errorMessage = '';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMessage = 'No speech was detected. Try speaking louder or checking your microphone.';
                        break;
                    case 'aborted':
                        errorMessage = 'Speech recognition was aborted.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'No microphone was found or microphone is not working.';
                        break;
                    case 'network':
                        errorMessage = 'Network error occurred during speech recognition.';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Microphone permission was denied. Please allow microphone access in your browser settings.';
                        break;
                    case 'service-not-allowed':
                        errorMessage = 'Speech recognition service is not allowed. Try on a different device or browser.';
                        break;
                    default:
                        errorMessage = `Error during speech recognition: ${event.error}`;
                }
                
                errorContainer.innerHTML = `<div class="error">${errorMessage}</div>`;
                
                // Do not stop on no-speech errors
                if (event.error !== 'no-speech') {
                    isRecording = false;
                    updateStatus(false);
                }
            };
        }
        
        function updateStatus(recording) {
            const statusElement = document.getElementById('status');
            const startButton = document.getElementById('start-btn');
            const stopButton = document.getElementById('stop-btn');
            
            if (recording) {
                statusElement.className = 'status active';
                statusElement.innerHTML = '<span class="mic-icon"></span> Status: Recording...';
                startButton.disabled = true;
                stopButton.disabled = false;
            } else {
                statusElement.className = 'status inactive';
                statusElement.innerText = 'Status: Not Recording';
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        }
        
        function startRecording() {
            // Clear any previous errors
            document.getElementById('error-container').innerHTML = '';
            
            // Initialize a new recognition instance
            initRecognition();
            
            try {
                log('Starting recognition...');
                recognition.start();
                isRecording = true;
            } catch (e) {
                log('Error starting recognition: ' + e.message);
                document.getElementById('error-container').innerHTML = `<div class="error">Failed to start speech recognition: ${e.message}</div>`;
            }
        }
        
        function stopRecording() {
            if (recognition) {
                isRecording = false;
                recognition.stop();
                log('Stopped recognition');
            }
        }
        
        // WebSocket setup
        let socket;
        let isConnected = false;
        let sessionId = null;
        const webSocketProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const webSocketUrl = `${webSocketProtocol}//${window.location.host}/ws`;
        
        function connectWebSocket() {
            try {
                socket = new WebSocket(webSocketUrl);
                
                socket.onopen = function() {
                    log('WebSocket connection established');
                    isConnected = true;
                    updateSocketUI(true);
                    
                    // Register as teacher with selected language
                    const language = document.getElementById('language-select').value;
                    registerRole('teacher', language);
                };
                
                socket.onclose = function() {
                    log('WebSocket connection closed');
                    isConnected = false;
                    updateSocketUI(false);
                };
                
                socket.onerror = function(error) {
                    log('WebSocket error: ' + JSON.stringify(error));
                    isConnected = false;
                    updateSocketUI(false);
                };
                
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    log('Received message: ' + JSON.stringify(message));
                    
                    if (message.type === 'connection' && message.sessionId) {
                        sessionId = message.sessionId;
                        document.getElementById('session-id').innerText = `Session ID: ${sessionId}`;
                    }
                    
                    // Add message to messages list
                    const messagesDiv = document.getElementById('messages');
                    const messageElement = document.createElement('div');
                    messageElement.innerText = `${message.type}: ${JSON.stringify(message)}`;
                    messagesDiv.prepend(messageElement);
                    
                    // Limit number of displayed messages
                    if (messagesDiv.children.length > 10) {
                        messagesDiv.removeChild(messagesDiv.lastChild);
                    }
                };
            } catch (e) {
                log('Error creating WebSocket: ' + e.message);
            }
        }
        
        function updateSocketUI(connected) {
            const statusDiv = document.getElementById('ws-status');
            
            if (connected) {
                statusDiv.innerText = 'Connected';
                statusDiv.style.color = 'green';
            } else {
                statusDiv.innerText = 'Disconnected (reconnecting...)';
                statusDiv.style.color = 'red';
                document.getElementById('session-id').innerText = 'Session ID: None';
                
                // Try to reconnect after 2 seconds
                setTimeout(connectWebSocket, 2000);
            }
        }
        
        function registerRole(role, languageCode) {
            if (!isConnected) {
                log('Cannot register role, not connected');
                return;
            }
            
            const message = {
                type: 'register',
                role: role,
                languageCode: languageCode
            };
            
            socket.send(JSON.stringify(message));
            log(`Registered as ${role} with language ${languageCode}`);
        }
        
        function sendTranscription(text) {
            if (!isConnected) {
                log('Cannot send transcription, not connected');
                return;
            }
            
            const message = {
                type: 'transcription',
                text: text
            };
            
            socket.send(JSON.stringify(message));
            log(`Sent transcription: "${text}"`);
        }
        
        // UI Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Speech buttons
            document.getElementById('start-btn').addEventListener('click', startRecording);
            document.getElementById('stop-btn').addEventListener('click', stopRecording);
            document.getElementById('clear-btn').addEventListener('click', function() {
                finalTranscript = '';
                document.getElementById('final-transcript').innerText = '';
                document.getElementById('interim-transcript').innerText = '';
                log('Cleared transcript');
            });
            
            // Language select
            document.getElementById('language-select').addEventListener('change', function() {
                const language = this.value;
                log(`Changed language to ${language}`);
                
                if (isRecording) {
                    stopRecording();
                    setTimeout(startRecording, 300);
                }
                
                if (isConnected) {
                    registerRole('teacher', language);
                }
            });
            
            // Set up category headers to expand/collapse
            document.querySelectorAll('.category-header').forEach(header => {
                header.addEventListener('click', function() {
                    const categoryId = this.getAttribute('data-category');
                    const content = this.nextElementSibling;
                    
                    // Toggle the collapsed class
                    this.classList.toggle('collapsed');
                    
                    // Toggle visibility
                    if (content.style.display === 'none') {
                        content.style.display = 'grid';
                    } else {
                        content.style.display = 'none';
                    }
                });
            });
            
            // Language options click handler
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    const language = this.getAttribute('data-lang');
                    
                    // Update dropdown value
                    document.getElementById('language-select').value = language;
                    
                    // Trigger change event
                    const event = new Event('change');
                    document.getElementById('language-select').dispatchEvent(event);
                    
                    // Update UI
                    updateSelectedLanguageInUI(language);
                });
            });
            
            // Function to update selected language UI
            function updateSelectedLanguageInUI(language) {
                // Remove selected class from all options
                document.querySelectorAll('.language-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Add selected class to the chosen language
                const selectedOption = document.querySelector(`.language-option[data-lang="${language}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                    
                    // Make sure the parent category is expanded
                    const parentContent = selectedOption.closest('.category-content');
                    if (parentContent) {
                        parentContent.style.display = 'grid';
                        const parentHeader = parentContent.previousElementSibling;
                        if (parentHeader) {
                            parentHeader.classList.remove('collapsed');
                        }
                    }
                }
            }
            
            // Set initial language UI state
            updateSelectedLanguageInUI(document.getElementById('language-select').value);
            
            // Connect WebSocket automatically
            connectWebSocket();
        });
    </script>
</body>
</html>