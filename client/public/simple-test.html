<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebSocket Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #f9f9f9;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 8px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button.disconnect {
            background-color: #f44336;
        }
        .status {
            margin-bottom: 16px;
            padding: 8px;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .status.disconnected {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .status.connecting {
            background-color: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }
        textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .logs {
            height: 200px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 8px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .log-error {
            color: #a94442;
        }
        .log-success {
            color: #3c763d;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #e0e0e0;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.teacher {
            background-color: #4CAF50;
            color: white;
        }
        .badge.student {
            background-color: #2196F3;
            color: white;
        }
        .role-buttons, .language-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .role-buttons button, .language-buttons button {
            flex: 1;
        }
        .role-buttons button.active, .language-buttons button.active {
            background-color: #333;
        }
    </style>
</head>
<body>
    <h1>Simple WebSocket Test</h1>
    
    <div class="card">
        <div class="card-title">Connection</div>
        <div id="status" class="status disconnected">Disconnected</div>
        <div>
            <span>Session ID:</span>
            <span id="session-id">None</span>
        </div>
        <div>
            <span>Role:</span>
            <span id="role" class="badge">Unset</span>
        </div>
        <div>
            <span>Language:</span>
            <span id="language" class="badge">en-US</span>
        </div>
        <div style="margin-top: 16px;">
            <button id="connect-btn">Connect</button>
            <button id="disconnect-btn" class="disconnect" disabled>Disconnect</button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">Role & Language</div>
        <div>
            <div>Role:</div>
            <div class="role-buttons">
                <button id="teacher-btn">Teacher</button>
                <button id="student-btn">Student</button>
            </div>
        </div>
        <div>
            <div>Language:</div>
            <div class="language-buttons">
                <button id="en-btn" class="active">English</button>
                <button id="es-btn">Spanish</button>
                <button id="fr-btn">French</button>
                <button id="de-btn">German</button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">Send Message</div>
        <textarea id="message" rows="4" placeholder="Type a message to send..."></textarea>
        <button id="send-btn" disabled>Send Transcription</button>
    </div>
    
    <div class="card">
        <div class="card-title">Logs</div>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        // Variables
        let socket = null;
        let sessionId = null;
        let role = 'teacher';
        let language = 'en-US';
        let connected = false;
        
        // Elements
        const statusEl = document.getElementById('status');
        const sessionIdEl = document.getElementById('session-id');
        const roleEl = document.getElementById('role');
        const languageEl = document.getElementById('language');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const teacherBtn = document.getElementById('teacher-btn');
        const studentBtn = document.getElementById('student-btn');
        const enBtn = document.getElementById('en-btn');
        const esBtn = document.getElementById('es-btn');
        const frBtn = document.getElementById('fr-btn');
        const deBtn = document.getElementById('de-btn');
        const messageInput = document.getElementById('message');
        const sendBtn = document.getElementById('send-btn');
        const logsEl = document.getElementById('logs');
        
        // Connect to WebSocket
        function connect() {
            if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) {
                log('Already connected or connecting');
                return;
            }
            
            // Create WebSocket URL
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws`;
            
            log(`Connecting to ${wsUrl}...`);
            setStatus('connecting');
            
            // Create WebSocket
            socket = new WebSocket(wsUrl);
            
            // Connection opened
            socket.onopen = () => {
                log('Connection established', 'success');
                setStatus('connected');
                setConnected(true);
                
                // Register role and language
                register(role, language);
            };
            
            // Listen for messages
            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    log(`Received: ${JSON.stringify(message, null, 2)}`, 'success');
                    
                    // Handle connection message
                    if (message.type === 'connection' && message.sessionId) {
                        sessionId = message.sessionId;
                        sessionIdEl.textContent = sessionId;
                    }
                } catch (e) {
                    log(`Error parsing message: ${e.message}`, 'error');
                }
            };
            
            // Connection closed
            socket.onclose = (event) => {
                log(`Connection closed: ${event.code} ${event.reason || 'No reason provided'}`);
                setStatus('disconnected');
                setConnected(false);
                sessionId = null;
                sessionIdEl.textContent = 'None';
            };
            
            // Connection error
            socket.onerror = (error) => {
                log('WebSocket error', 'error');
                console.error('WebSocket error:', error);
            };
        }
        
        // Disconnect from WebSocket
        function disconnect() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Not connected');
                return;
            }
            
            socket.close(1000, 'User disconnected');
        }
        
        // Register role and language
        function register(newRole, newLanguage) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Cannot register - not connected', 'error');
                return;
            }
            
            role = newRole;
            language = newLanguage;
            
            // Update UI
            roleEl.textContent = role;
            roleEl.className = `badge ${role}`;
            languageEl.textContent = language;
            
            // Send register message
            const message = {
                type: 'register',
                role: role,
                languageCode: language
            };
            
            socket.send(JSON.stringify(message));
            log(`Registered as ${role} with language ${language}`);
        }
        
        // Send transcription
        function sendTranscription(text) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Cannot send - not connected', 'error');
                return;
            }
            
            const message = {
                type: 'transcription',
                text: text
            };
            
            socket.send(JSON.stringify(message));
            log(`Sent transcription: ${text}`);
        }
        
        // Set status
        function setStatus(status) {
            statusEl.className = `status ${status}`;
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        // Set connected state
        function setConnected(isConnected) {
            connected = isConnected;
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            sendBtn.disabled = !isConnected;
        }
        
        // Add a log entry
        function log(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type ? 'log-' + type : ''}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsEl.appendChild(logItem);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        // Event Listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        teacherBtn.addEventListener('click', () => {
            teacherBtn.classList.add('active');
            studentBtn.classList.remove('active');
            register('teacher', language);
        });
        
        studentBtn.addEventListener('click', () => {
            studentBtn.classList.add('active');
            teacherBtn.classList.remove('active');
            register('student', language);
        });
        
        enBtn.addEventListener('click', () => {
            enBtn.classList.add('active');
            esBtn.classList.remove('active');
            frBtn.classList.remove('active');
            deBtn.classList.remove('active');
            register(role, 'en-US');
        });
        
        esBtn.addEventListener('click', () => {
            esBtn.classList.add('active');
            enBtn.classList.remove('active');
            frBtn.classList.remove('active');
            deBtn.classList.remove('active');
            register(role, 'es-ES');
        });
        
        frBtn.addEventListener('click', () => {
            frBtn.classList.add('active');
            enBtn.classList.remove('active');
            esBtn.classList.remove('active');
            deBtn.classList.remove('active');
            register(role, 'fr-FR');
        });
        
        deBtn.addEventListener('click', () => {
            deBtn.classList.add('active');
            enBtn.classList.remove('active');
            esBtn.classList.remove('active');
            frBtn.classList.remove('active');
            register(role, 'de-DE');
        });
        
        sendBtn.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                sendTranscription(text);
                messageInput.value = '';
            } else {
                log('Cannot send empty message', 'error');
            }
        });
        
        // Init
        teacherBtn.classList.add('active');
        log('Page loaded. Click Connect to start.');
    </script>
</body>
</html>