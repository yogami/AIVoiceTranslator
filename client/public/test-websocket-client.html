<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocketClient Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 4px;
      display: inline-block;
    }
    .connected { background-color: #dff0d8; color: #3c763d; }
    .connecting { background-color: #fcf8e3; color: #8a6d3b; }
    .disconnected { background-color: #f2dede; color: #a94442; }
    .error { background-color: #f2dede; color: #a94442; }
    
    button {
      padding: 10px 15px;
      margin-right: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    #logContainer {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      background-color: #f5f5f5;
      font-family: monospace;
    }
    .log-item {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .log-error { color: #a94442; }
    .log-warning { color: #8a6d3b; }
    .log-info { color: #31708f; }
  </style>
</head>
<body>
  <h1>WebSocketClient Test Page</h1>
  
  <div class="card">
    <h2>Connection Status</h2>
    <p>Current Status: <span id="status" class="status disconnected">disconnected</span></p>
    <p>Session ID: <span id="sessionId">Not Connected</span></p>
    
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
  </div>
  
  <div class="card">
    <h2>Send Message</h2>
    <p>
      <select id="messageType">
        <option value="ping">Ping</option>
        <option value="register">Register</option>
        <option value="transcription">Transcription</option>
      </select>
      
      <input type="text" id="messageText" placeholder="Message text (for transcription)" style="width: 300px; padding: 8px;">
      
      <button id="sendBtn" disabled>Send</button>
    </p>
  </div>
  
  <div class="card">
    <h2>Event Log</h2>
    <div id="logContainer"></div>
  </div>
  
  <!-- Load our refactored WebSocketClient -->
  <script src="js/refactored-websocket-client.js"></script>
  
  <!-- Test script -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // UI Elements
    const statusElement = document.getElementById('status');
    const sessionIdElement = document.getElementById('sessionId');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const messageTypeSelect = document.getElementById('messageType');
    const messageTextInput = document.getElementById('messageText');
    const sendBtn = document.getElementById('sendBtn');
    const logContainer = document.getElementById('logContainer');
    
    // Create WebSocketClient instance
    const client = new WebSocketClient();
    
    // Update UI based on connection status
    function updateConnectionStatus(status) {
      statusElement.textContent = status;
      statusElement.className = 'status ' + status;
      
      connectBtn.disabled = (status === 'connected' || status === 'connecting');
      disconnectBtn.disabled = (status === 'disconnected' || status === 'error');
      sendBtn.disabled = (status !== 'connected');
    }
    
    // Log messages
    function log(message, type = 'info') {
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(logItem);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Set up event listeners for WebSocketClient
    client.addEventListener('status', (status) => {
      log(`Connection status changed: ${status}`);
      updateConnectionStatus(status);
    });
    
    client.addEventListener('sessionId', (sessionId) => {
      log(`Session ID received: ${sessionId}`);
      sessionIdElement.textContent = sessionId;
    });
    
    client.addEventListener('open', () => {
      log('WebSocket connection opened');
    });
    
    client.addEventListener('message', (message) => {
      log(`Received message: ${JSON.stringify(message)}`);
    });
    
    client.addEventListener('error', (error) => {
      log(`WebSocket error: ${error}`, 'error');
    });
    
    client.addEventListener('close', (event) => {
      log(`WebSocket closed: ${event.code} ${event.reason || 'No reason'}`, 'warning');
      sessionIdElement.textContent = 'Not Connected';
    });
    
    // Connect button
    connectBtn.addEventListener('click', () => {
      log('Connecting to WebSocket server...');
      client.connect().catch(error => {
        log(`Failed to connect: ${error}`, 'error');
      });
    });
    
    // Disconnect button
    disconnectBtn.addEventListener('click', () => {
      log('Disconnecting from WebSocket server...');
      client.disconnect();
    });
    
    // Send button
    sendBtn.addEventListener('click', () => {
      const type = messageTypeSelect.value;
      const text = messageTextInput.value;
      
      let message;
      switch (type) {
        case 'ping':
          message = { type: 'ping', timestamp: Date.now() };
          break;
        case 'register':
          message = { 
            type: 'register', 
            role: 'student', 
            languageCode: 'en-US',
            settings: { ttsServiceType: 'browser' }
          };
          break;
        case 'transcription':
          if (!text) {
            log('Please enter text for transcription', 'warning');
            return;
          }
          message = { type: 'transcription', text: text };
          break;
      }
      
      log(`Sending message: ${JSON.stringify(message)}`);
      const success = client.send(message);
      
      if (!success) {
        log('Failed to send message', 'error');
      }
    });
    
    // Initial status update
    updateConnectionStatus(client.getStatus());
    log('WebSocketClient Test Page loaded');
  });
  </script>
</body>
</html>