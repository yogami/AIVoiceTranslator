<!DOCTYPE html>
<html>
<head>
    <title>Bare WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { border: 1px solid #ccc; padding: 10px; margin-top: 10px; height: 300px; overflow-y: auto; }
        button { padding: 10px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Bare WebSocket Test</h1>
    <button id="connect">Connect WebSocket</button>
    <button id="register">Register as Student</button>
    <button id="disconnect">Disconnect</button>
    <div>
        <h3>Connection Details:</h3>
        <div id="details">Not connected</div>
    </div>
    <div>
        <h3>Log:</h3>
        <div id="log"></div>
    </div>
    
    <script>
        let socket = null;
        
        function log(message, type) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            if (type) {
                entry.classList.add(type);
            }
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateDetails() {
            const detailsDiv = document.getElementById('details');
            
            if (!socket) {
                detailsDiv.textContent = 'Not connected';
                return;
            }
            
            const states = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
            const state = states[socket.readyState] || 'UNKNOWN';
            
            detailsDiv.innerHTML = `
                <div>Status: <strong>${state}</strong> (${socket.readyState})</div>
                <div>URL: ${socket.url}</div>
            `;
        }
        
        document.getElementById('connect').addEventListener('click', function() {
            try {
                if (socket && socket.readyState !== WebSocket.CLOSED) {
                    log('Closing existing connection first', 'error');
                    socket.close();
                }
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                log(`Connecting to ${wsUrl}...`);
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(event) {
                    log('Connection established!', 'success');
                    updateDetails();
                };
                
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    log(`Received: ${JSON.stringify(message)}`, 'success');
                    
                    if (message.type === 'connection' && message.sessionId) {
                        log(`Session ID: ${message.sessionId}`, 'success');
                    }
                };
                
                socket.onclose = function(event) {
                    log(`Connection closed: ${event.code} - ${event.reason}`);
                    updateDetails();
                };
                
                socket.onerror = function(error) {
                    log(`ERROR: ${JSON.stringify(error)}`, 'error');
                    updateDetails();
                };
                
                updateDetails();
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('register').addEventListener('click', function() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Cannot register: WebSocket not connected', 'error');
                return;
            }
            
            const registerMessage = {
                type: 'register',
                role: 'student',
                languageCode: 'es-ES'
            };
            
            log(`Sending registration message: ${JSON.stringify(registerMessage)}`);
            socket.send(JSON.stringify(registerMessage));
        });
        
        document.getElementById('disconnect').addEventListener('click', function() {
            if (!socket) {
                log('No connection to close', 'error');
                return;
            }
            
            log('Closing connection...');
            socket.close();
            updateDetails();
        });
        
        updateDetails();
    </script>
</body>
</html>
