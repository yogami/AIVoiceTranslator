<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student WebSocket Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: #f9f9f9;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 8px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button.disconnect {
            background-color: #f44336;
        }
        .status {
            margin-bottom: 16px;
            padding: 8px;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .status.disconnected {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .status.connecting {
            background-color: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }
        .logs {
            height: 200px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 8px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-item {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .log-error {
            color: #a94442;
        }
        .log-success {
            color: #3c763d;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #e0e0e0;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.teacher {
            background-color: #4CAF50;
            color: white;
        }
        .badge.student {
            background-color: #2196F3;
            color: white;
        }
        .language-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .language-buttons button {
            flex: 1;
        }
        .language-buttons button.active {
            background-color: #333;
        }
        .translations {
            height: 300px;
            overflow-y: auto;
            background-color: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .translation-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }
        .translation-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .translation-text {
            font-size: 16px;
        }
        .student-header {
            background-color: #2196F3;
            color: white;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="student-header">STUDENT VIEW</div>
    <h1>Real-time Translation Receiver</h1>
    
    <div class="card">
        <div class="card-title">Connection</div>
        <div id="status" class="status disconnected">Disconnected</div>
        <div>
            <span>Session ID:</span>
            <span id="session-id">None</span>
        </div>
        <div>
            <span>Role:</span>
            <span id="role" class="badge student">student</span>
        </div>
        <div>
            <span>Language:</span>
            <span id="language" class="badge">es-ES</span>
        </div>
        <div style="margin-top: 16px;">
            <button id="connect-btn">Connect as Student</button>
            <button id="disconnect-btn" class="disconnect" disabled>Disconnect</button>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">Language Selection</div>
        <div>
            <div>Preferred Language:</div>
            <div class="language-buttons">
                <button id="en-btn">English</button>
                <button id="es-btn" class="active">Spanish</button>
                <button id="fr-btn">French</button>
                <button id="de-btn">German</button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">Incoming Translations</div>
        <div id="translations" class="translations">
            <div style="text-align: center; color: #666; margin-top: 100px;">
                No translations received yet. <br>
                Connect as a student and wait for the teacher to speak.
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-title">Connection Logs</div>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        // Variables
        let socket = null;
        let sessionId = null;
        let role = 'student';
        let language = 'es-ES';
        let connected = false;
        
        // Elements
        const statusEl = document.getElementById('status');
        const sessionIdEl = document.getElementById('session-id');
        const roleEl = document.getElementById('role');
        const languageEl = document.getElementById('language');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const enBtn = document.getElementById('en-btn');
        const esBtn = document.getElementById('es-btn');
        const frBtn = document.getElementById('fr-btn');
        const deBtn = document.getElementById('de-btn');
        const translationsEl = document.getElementById('translations');
        const logsEl = document.getElementById('logs');
        
        // Connect to WebSocket
        function connect() {
            if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) {
                log('Already connected or connecting');
                return;
            }
            
            // Create WebSocket URL
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws`;
            
            log(`Connecting to ${wsUrl}...`);
            setStatus('connecting');
            
            // Create WebSocket
            socket = new WebSocket(wsUrl);
            
            // Connection opened
            socket.onopen = () => {
                log('Connection established', 'success');
                setStatus('connected');
                setConnected(true);
                
                // Register role and language
                register(role, language);
            };
            
            // Listen for messages
            socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    log(`Received: ${JSON.stringify(message, null, 2)}`, 'success');
                    
                    // Handle connection message
                    if (message.type === 'connection' && message.sessionId) {
                        sessionId = message.sessionId;
                        sessionIdEl.textContent = sessionId;
                        
                        // Add a success notification
                        const successNote = document.createElement('div');
                        successNote.style.padding = '10px';
                        successNote.style.marginTop = '10px';
                        successNote.style.backgroundColor = '#dff0d8';
                        successNote.style.color = '#3c763d';
                        successNote.style.borderRadius = '4px';
                        successNote.style.border = '1px solid #d6e9c6';
                        successNote.style.fontWeight = 'bold';
                        successNote.textContent = '✓ CONNECTION SUCCESSFUL! Waiting for teacher translations...';
                        
                        // Insert at the top
                        document.body.insertBefore(successNote, document.body.firstChild);
                        
                        // Auto-remove after 5 seconds
                        setTimeout(() => {
                            successNote.style.opacity = '0';
                            successNote.style.transition = 'opacity 1s';
                            setTimeout(() => successNote.remove(), 1000);
                        }, 5000);
                    }
                    
                    // Handle translation message
                    if (message.type === 'translation') {
                        addTranslation(message.text, message.originalLanguage, message.translatedLanguage);
                    }
                } catch (e) {
                    log(`Error parsing message: ${e.message}`, 'error');
                }
            };
            
            // Connection closed
            socket.onclose = (event) => {
                log(`Connection closed: ${event.code} ${event.reason || 'No reason provided'}`);
                setStatus('disconnected');
                setConnected(false);
                sessionId = null;
                sessionIdEl.textContent = 'None';
            };
            
            // Connection error
            socket.onerror = (error) => {
                log('WebSocket error', 'error');
                console.error('WebSocket error:', error);
            };
        }
        
        // Disconnect from WebSocket
        function disconnect() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Not connected');
                return;
            }
            
            socket.close(1000, 'User disconnected');
        }
        
        // Register role and language
        function register(newRole, newLanguage) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('Cannot register - not connected', 'error');
                return;
            }
            
            role = newRole;
            language = newLanguage;
            
            // Update UI
            roleEl.textContent = role;
            roleEl.className = `badge ${role}`;
            languageEl.textContent = language;
            
            // Send register message
            const message = {
                type: 'register',
                role: role,
                languageCode: language
            };
            
            socket.send(JSON.stringify(message));
            log(`Registered as ${role} with language ${language}`);
        }
        
        // Add a translation to the list
        function addTranslation(text, originalLanguage, translatedLanguage) {
            // Clear initial message if this is the first translation
            if (translationsEl.querySelector('div[style*="text-align: center"]')) {
                translationsEl.innerHTML = '';
            }
            
            const translationItem = document.createElement('div');
            translationItem.className = 'translation-item';
            
            const timeEl = document.createElement('div');
            timeEl.className = 'translation-time';
            timeEl.textContent = `${new Date().toLocaleTimeString()} · ${getLanguageName(originalLanguage)} → ${getLanguageName(translatedLanguage)}`;
            
            const textEl = document.createElement('div');
            textEl.className = 'translation-text';
            textEl.textContent = text;
            
            translationItem.appendChild(timeEl);
            translationItem.appendChild(textEl);
            
            translationsEl.appendChild(translationItem);
            translationsEl.scrollTop = translationsEl.scrollHeight;
            
            // Highlight for a moment
            setTimeout(() => {
                translationItem.style.backgroundColor = '#f0f8ff';
                translationItem.style.transition = 'background-color 1.5s';
            }, 1000);
        }
        
        // Get language name from code
        function getLanguageName(code) {
            const languages = {
                'en-US': 'English',
                'es-ES': 'Spanish',
                'fr-FR': 'French',
                'de-DE': 'German'
            };
            
            return languages[code] || code;
        }
        
        // Set status
        function setStatus(status) {
            statusEl.className = `status ${status}`;
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        // Set connected state
        function setConnected(isConnected) {
            connected = isConnected;
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
        }
        
        // Add a log entry
        function log(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type ? 'log-' + type : ''}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsEl.appendChild(logItem);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        // Event Listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        enBtn.addEventListener('click', () => {
            enBtn.classList.add('active');
            esBtn.classList.remove('active');
            frBtn.classList.remove('active');
            deBtn.classList.remove('active');
            register(role, 'en-US');
        });
        
        esBtn.addEventListener('click', () => {
            esBtn.classList.add('active');
            enBtn.classList.remove('active');
            frBtn.classList.remove('active');
            deBtn.classList.remove('active');
            register(role, 'es-ES');
        });
        
        frBtn.addEventListener('click', () => {
            frBtn.classList.add('active');
            enBtn.classList.remove('active');
            esBtn.classList.remove('active');
            deBtn.classList.remove('active');
            register(role, 'fr-FR');
        });
        
        deBtn.addEventListener('click', () => {
            deBtn.classList.add('active');
            enBtn.classList.remove('active');
            esBtn.classList.remove('active');
            frBtn.classList.remove('active');
            register(role, 'de-DE');
        });
        
        // Init
        log('Page loaded. Click "Connect as Student" to start receiving translations.');
    </script>
</body>
</html>