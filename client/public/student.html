<!DOCTYPE html>
<!-- 
    AIVoiceTranslator Student Interface
    
    Architecture Note: TTS service selection is now controlled by the teacher.
    Students can see which TTS service is active but cannot change it.
    They can play examples of different TTS services for comparison only.
    
    The architecture follows these principles:
    - Centralized control by the teacher for classroom consistency
    - Read-only display of TTS service selection for students
    - TTS comparison capabilities for educational purposes
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student View - AIVoiceTranslator</title>
    <script src="js/language-support.js"></script>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .back-link {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .indicator.connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .indicator.disconnected {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.2s;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #connect-btn {
            background: #4caf50;
            color: white;
        }
        
        #connect-btn:hover:not(:disabled) {
            background: #45a049;
        }
        
        #disconnect-btn {
            background: #f44336;
            color: white;
        }
        
        #disconnect-btn:hover:not(:disabled) {
            background: #da190b;
        }
        
        .language-dropdown {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            margin-top: 10px;
        }
        
        .language-dropdown:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .translation-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            min-height: 120px;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .translation-box:empty:before {
            content: "Teacher's speech will appear here...";
            color: #6c757d;
            font-style: italic;
        }
        
        .audio-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        #play-button {
            background: #28a745;
            color: white;
            font-size: 1.1rem;
            padding: 15px 25px;
        }
        
        #play-button:hover:not(:disabled) {
            background: #218838;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Add display styles for button toggling */
        button.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Home</a>
        
        <h1>Student Translator</h1>
        
        <div id="error-container"></div>
        <div id="success-container"></div>
        
        <div id="connection-status" class="status disconnected">
            <span id="connection-indicator" class="indicator disconnected"></span>
            <span id="connection-text">Disconnected</span>
        </div>
        
        <div class="controls">
            <button id="connect-btn">Connect</button>
            <button id="disconnect-btn" class="hidden" disabled>Disconnect</button>
        </div>
        
        <div>
            <label for="simplified-language-select">Select Your Language:</label>
            <select id="simplified-language-select" class="language-dropdown">
                <option value="" disabled selected>Choose a language...</option>
                <!-- Common Languages -->
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="zh">Chinese (Simplified)</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="ar">Arabic</option>
                <option value="hi">Hindi</option>
                <option value="pt">Portuguese</option>
                <option value="ru">Russian</option>
                <option value="it">Italian</option>
                
                <!-- Additional Languages (Alphabetical) -->
                <option value="af">Afrikaans</option>
                <option value="am">Amharic</option>
                <option value="az">Azerbaijani</option>
                <option value="be">Belarusian</option>
                <option value="bg">Bulgarian</option>
                <option value="bn">Bengali</option>
                <option value="bs">Bosnian</option>
                <option value="ca">Catalan</option>
                <option value="cs">Czech</option>
                <option value="da">Danish</option>
                <option value="el">Greek</option>
                <option value="et">Estonian</option>
                <option value="fa">Persian</option>
                <option value="fi">Finnish</option>
                <option value="fil">Filipino</option>
                <option value="gu">Gujarati</option>
                <option value="he">Hebrew</option>
                <option value="hr">Croatian</option>
                <option value="hu">Hungarian</option>
                <option value="hy">Armenian</option>
                <option value="id">Indonesian</option>
                <option value="is">Icelandic</option>
                <option value="jv">Javanese</option>
                <option value="ka">Georgian</option>
                <option value="kk">Kazakh</option>
                <option value="km">Khmer</option>
                <option value="kn">Kannada</option>
                <option value="lo">Lao</option>
                <option value="lt">Lithuanian</option>
                <option value="lv">Latvian</option>
                <option value="mk">Macedonian</option>
                <option value="ml">Malayalam</option>
                <option value="mn">Mongolian</option>
                <option value="mr">Marathi</option>
                <option value="ms">Malay</option>
                <option value="my">Burmese</option>
                <option value="ne">Nepali</option>
                <option value="nl">Dutch</option>
                <option value="no">Norwegian</option>
                <option value="pa">Punjabi</option>
                <option value="pl">Polish</option>
                <option value="ro">Romanian</option>
                <option value="si">Sinhala</option>
                <option value="sk">Slovak</option>
                <option value="sl">Slovenian</option>
                <option value="sq">Albanian</option>
                <option value="sr">Serbian</option>
                <option value="sv">Swedish</option>
                <option value="sw">Swahili</option>
                <option value="ta">Tamil</option>
                <option value="te">Telugu</option>
                <option value="th">Thai</option>
                <option value="tr">Turkish</option>
                <option value="uk">Ukrainian</option>
                <option value="ur">Urdu</option>
                <option value="uz">Uzbek</option>
                <option value="vi">Vietnamese</option>
                
                <!-- Regional Variants -->
                <option value="en-US">English (United States)</option>
                <option value="en-GB">English (UK)</option>
                <option value="en-AU">English (Australia)</option>
                <option value="es-ES">Spanish (Spain)</option>
                <option value="es-MX">Spanish (Mexico)</option>
                <option value="pt-BR">Portuguese (Brazil)</option>
                <option value="pt-PT">Portuguese (Portugal)</option>
                <option value="fr-FR">French (France)</option>
                <option value="fr-CA">French (Canada)</option>
                <option value="zh-TW">Chinese (Traditional)</option>
            </select>
            <!-- Hidden select for backward compatibility -->
            <select id="language-select" style="display: none;">
                <option value="en-US">English (United States)</option>
            </select>
        </div>
    </div>
        
    <div class="container">
        <h3>Translated Speech</h3>
        <div id="translation-box" class="translation-box">
            Connect and select a language to receive translated speech from the teacher.
        </div>
        
        <div class="audio-controls">
            <audio id="audio-player" controls style="display: none;"></audio>
            <button id="play-button" disabled>
                <span>‚ñ∂</span> Play Translation
            </button>
        </div>
    </div>
    
    <script>
        // Global variables
        let socket;
        let isConnected = false;
        let sessionId = null;
        let selectedLanguage = document.getElementById('language-select').value;
        
        function log(message) {
            console.log(message);
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => errorContainer.innerHTML = '', 5000);
        }
        
        function showSuccess(message) {
            const successContainer = document.getElementById('success-container');
            successContainer.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => successContainer.innerHTML = '', 3000);
        }
        
        function connectWebSocket() {
            // Prevent double clicks
            if (isConnected || document.getElementById('connect-btn').disabled) {
                return;
            }
            
            // Immediately update UI to show connecting state
            updateConnectionUI('connecting');
            
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function() {
                    isConnected = true;
                    updateConnectionUI(true);
                    showSuccess('Connected to classroom');
                    registerAsStudent(selectedLanguage);
                };
                
                socket.onclose = function() {
                    isConnected = false;
                    updateConnectionUI(false);
                };
                
                socket.onerror = function(error) {
                    showError('Connection error. Please try again.');
                    isConnected = false;
                    updateConnectionUI(false);
                };
                
                socket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    
                    if (message.type === 'connection' && message.sessionId) {
                        sessionId = message.sessionId;
                    }
                    
                    if (message.type === 'translation') {
                        displayTranslation(message.text, message.sourceLanguage, message.targetLanguage, 
                                         message.originalText, message.audioData, message.useClientSpeech, 
                                         message.ttsServiceType);
                    }
                };
            } catch (error) {
                showError('Failed to establish connection: ' + error.message);
                isConnected = false;
                updateConnectionUI(false);
            }
        }
        
        function disconnectWebSocket() {
            // Prevent double clicks
            if (!isConnected || document.getElementById('disconnect-btn').disabled) {
                return;
            }
            
            // Immediately update UI to show disconnecting state
            updateConnectionUI('disconnecting');
            
            if (socket) {
                socket.close();
            } else {
                // If no socket exists, just update UI to disconnected
                isConnected = false;
                updateConnectionUI(false);
            }
        }
        
        function registerAsStudent(languageCode) {
            if (!isConnected) {
                showError('Not connected to classroom');
                return;
            }
            
            const message = {
                type: 'register',
                role: 'student',
                languageCode: languageCode
            };
            
            socket.send(JSON.stringify(message));
            showSuccess(`Receiving translations in ${getLanguageName(languageCode)}`);
        }
        
        function updateConnectionUI(state) {
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const indicator = document.getElementById('connection-indicator');
            const connectionText = document.getElementById('connection-text');
            const connectionStatus = document.getElementById('connection-status');
            
            if (state === 'connecting') {
                indicator.className = 'indicator disconnected';
                connectionText.textContent = '‚è≥ Connecting...';
                connectionStatus.className = 'status disconnected';
                connectBtn.textContent = 'Connecting...';
                connectBtn.disabled = true;
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
            } else if (state === 'disconnecting') {
                indicator.className = 'indicator connected';
                connectionText.textContent = '‚è≥ Disconnecting...';
                connectionStatus.className = 'status connected';
                disconnectBtn.textContent = 'Disconnecting...';
                disconnectBtn.disabled = true;
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
            } else if (state === true) {
                // Connected state
                indicator.className = 'indicator connected';
                connectionText.textContent = '‚úì Connected to Classroom';
                connectionStatus.className = 'status connected';
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                disconnectBtn.textContent = 'Disconnect';
                disconnectBtn.disabled = false;
            } else {
                // Disconnected state
                indicator.className = 'indicator disconnected';
                connectionText.textContent = '‚úó Disconnected';
                connectionStatus.className = 'status disconnected';
                connectBtn.classList.remove('hidden');
                connectBtn.textContent = 'Connect';
                connectBtn.disabled = false;
                disconnectBtn.classList.add('hidden');
            }
        }
        
        function displayTranslation(text, sourceLanguage, targetLanguage, originalText, audioData, useClientSpeech, ttsServiceType) {
            const translationBox = document.getElementById('translation-box');
            const audio = document.getElementById('audio-player');
            const playButton = document.getElementById('play-button');
            
            // Display translation
            let html = '';
            if (originalText) {
                html += `<p style="color: #6c757d; font-size: 0.9em; margin-bottom: 10px;">"${originalText}"</p>`;
            }
            html += `<p style="font-size: 1.2em; font-weight: bold; margin: 0;">${text}</p>`;
            translationBox.innerHTML = html;
            
            // Handle audio
            if (ttsServiceType === 'silent') {
                playButton.disabled = true;
                playButton.innerHTML = '<span>üîá</span> Audio Disabled';
            } else if (audioData && audioData.length > 0) {
                try {
                    const binaryString = atob(audioData);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    const blob = new Blob([bytes.buffer], { type: 'audio/mp3' });
                    const audioURL = URL.createObjectURL(blob);
                    
                    audio.src = audioURL;
                    playButton.disabled = false;
                    playButton.innerHTML = '<span>‚ñ∂</span> Play Translation';
                    
                    playButton.onclick = () => {
                        audio.play();
                        playButton.innerHTML = '<span>üîä</span> Playing...';
                    };
                    
                    audio.onended = () => {
                        playButton.innerHTML = '<span>‚ñ∂</span> Play Translation';
                    };
                    
                    // Auto-play
                    setTimeout(() => audio.play(), 100);
                    
                } catch (error) {
                    generateSpeechFromText(text, targetLanguage);
                }
            } else {
                generateSpeechFromText(text, targetLanguage);
            }
        }
        
        function generateSpeechFromText(text, languageCode) {
            const playButton = document.getElementById('play-button');
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = languageCode || 'en-US';
                
                playButton.disabled = false;
                playButton.innerHTML = '<span>‚ñ∂</span> Play Translation';
                
                playButton.onclick = () => {
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                    playButton.innerHTML = '<span>üîä</span> Playing...';
                };
                
                utterance.onend = () => {
                    playButton.innerHTML = '<span>‚ñ∂</span> Play Translation';
                };
                
                showSuccess('Translation audio ready');
            } else {
                playButton.disabled = true;
                showError('Audio not supported in your browser');
            }
        }
        
        function getLanguageName(code) {
            const languages = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French', 'de': 'German',
                'zh': 'Chinese', 'ja': 'Japanese', 'ko': 'Korean', 'ar': 'Arabic',
                'hi': 'Hindi', 'pt': 'Portuguese', 'ru': 'Russian', 'it': 'Italian'
            };
            return languages[code] || code;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const languageSelect = document.getElementById('language-select');
            const simplifiedLanguageSelect = document.getElementById('simplified-language-select');
            
            connectBtn.addEventListener('click', connectWebSocket);
            disconnectBtn.addEventListener('click', disconnectWebSocket);
            
            // Language selection
            if (simplifiedLanguageSelect) {
                simplifiedLanguageSelect.addEventListener('change', function() {
                    const lang = this.value;
                    if (!lang) return;
                    
                    selectedLanguage = lang;
                    languageSelect.value = lang;
                    
                    if (isConnected) {
                        registerAsStudent(lang);
                        showSuccess(`Language changed to ${this.options[this.selectedIndex].text}`);
                    }
                });
            }
            
            if (languageSelect) {
                languageSelect.addEventListener('change', function() {
                    selectedLanguage = this.value;
                    if (isConnected) {
                        registerAsStudent(selectedLanguage);
                    }
                });
            }
        });
    </script>
</body>
</html>
