<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Interface - AIVoiceTranslator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéß</text></svg>">
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .back-link {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .indicator.connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        
        .indicator.disconnected {
            background-color: #dc3545;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.2s;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #connect-btn {
            background: #4caf50;
            color: white;
        }
        
        #connect-btn:hover:not(:disabled) {
            background: #45a049;
        }
        
        #connect-btn.connected {
            background: #f44336;
        }
        
        #connect-btn.connected:hover:not(:disabled) {
            background: #da190b;
        }
        
        /* Remove the separate disconnect button styles */
        #disconnect-btn {
            display: none;
        }
        
        .language-dropdown {
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            margin-top: 10px;
        }
        
        .language-dropdown:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .translation-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            min-height: 120px;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .translation-box:empty:before {
            content: "Teacher's speech will appear here...";
            color: #6c757d;
            font-style: italic;
        }
        
        .audio-controls {
            text-align: center;
            margin: 20px 0;
        }
        
        #play-button {
            background: #28a745;
            color: white;
            font-size: 1.1rem;
            padding: 15px 25px;
        }
        
        #play-button:hover:not(:disabled) {
            background: #218838;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Add display styles for button toggling */
        button.hidden {
            display: none;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-group input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(100% - 22px);
        }
        
        .input-group button {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .input-group button:hover {
            background: #0056b3;
        }
        
        .session-section {
            margin-bottom: 30px;
            padding: 15px;
            background: #f1f1f1;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        /* Simplified styles for auto-join interface */
        .connection-status {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .language-section {
            margin-bottom: 20px;
        }
        
        .translation-container {
            margin-bottom: 20px;
        }
        
        .waiting-message {
            color: #6c757d;
            font-style: italic;
        }
        
        .translation-item {
            margin-bottom: 10px;
        }
        
        .original-text {
            margin: 0;
            font-weight: 500;
        }
        
        .translated-text {
            margin: 0;
            font-weight: bold;
        }
        
        .language-info {
            margin: 0;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        /* Language selection styles */
        .language-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .language-category {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .category-header {
            background: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-content {
            padding: 15px;
            display: none;
        }
        
        .category-content.active {
            display: block;
        }
        
        .language-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .language-option:hover {
            background-color: #f8f9fa;
        }
        
        .language-option.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß Student Interface</h1>
        
        <div id="connection-status" class="status disconnected">
            <div class="indicator disconnected"></div>
            <span>Disconnected</span>
        </div>
        
        <!-- Language Selection with Categories -->
        <div class="language-section">
            <h3>üåç Select Your Language</h3>
            <div class="language-selection">
                <select id="language-dropdown" class="language-dropdown">
                    <option value="">Choose your language...</option>
                    
                    <!-- Major Languages -->
                    <option value="en-US">üá∫üá∏ English (United States)</option>
                    <option value="en-GB">üá¨üáß English (United Kingdom)</option>
                    <option value="en-AU">üá¶üá∫ English (Australia)</option>
                    <option value="en-CA">üá®üá¶ English (Canada)</option>
                    
                    <!-- European Languages -->
                    <option value="es-ES">üá™üá∏ Spanish (Spain)</option>
                    <option value="es-MX">üá≤üáΩ Spanish (Mexico)</option>
                    <option value="es-AR">üá¶üá∑ Spanish (Argentina)</option>
                    <option value="fr-FR">üá´üá∑ French (France)</option>
                    <option value="fr-CA">üá®üá¶ French (Canada)</option>
                    <option value="de-DE">üá©üá™ German (Germany)</option>
                    <option value="it-IT">üáÆüáπ Italian (Italy)</option>
                    <option value="pt-PT">üáµüáπ Portuguese (Portugal)</option>
                    <option value="pt-BR">üáßüá∑ Portuguese (Brazil)</option>
                    <option value="ru-RU">üá∑üá∫ Russian (Russia)</option>
                    <option value="pl-PL">üáµüá± Polish (Poland)</option>
                    <option value="nl-NL">üá≥üá± Dutch (Netherlands)</option>
                    <option value="sv-SE">üá∏üá™ Swedish (Sweden)</option>
                    <option value="da-DK">üá©üá∞ Danish (Denmark)</option>
                    <option value="no-NO">üá≥üá¥ Norwegian (Norway)</option>
                    <option value="fi-FI">üá´üáÆ Finnish (Finland)</option>
                    <option value="is-IS">üáÆüá∏ Icelandic (Iceland)</option>
                    <option value="hu-HU">üá≠üá∫ Hungarian (Hungary)</option>
                    <option value="cs-CZ">üá®üáø Czech (Czech Republic)</option>
                    <option value="sk-SK">üá∏üá∞ Slovak (Slovakia)</option>
                    <option value="sl-SI">üá∏üáÆ Slovenian (Slovenia)</option>
                    <option value="hr-HR">üá≠üá∑ Croatian (Croatia)</option>
                    <option value="sr-RS">üá∑üá∏ Serbian (Serbia)</option>
                    <option value="bg-BG">üáßüá¨ Bulgarian (Bulgaria)</option>
                    <option value="ro-RO">üá∑üá¥ Romanian (Romania)</option>
                    <option value="el-GR">üá¨üá∑ Greek (Greece)</option>
                    <option value="tr-TR">üáπüá∑ Turkish (Turkey)</option>
                    
                    <!-- Asian Languages -->
                    <option value="zh-CN">üá®üá≥ Chinese (Simplified)</option>
                    <option value="zh-TW">üáπüáº Chinese (Traditional)</option>
                    <option value="ja-JP">üáØüáµ Japanese (Japan)</option>
                    <option value="ko-KR">üá∞üá∑ Korean (Korea)</option>
                    <option value="hi-IN">üáÆüá≥ Hindi (India)</option>
                    <option value="bn-IN">üáÆüá≥ Bengali (India)</option>
                    <option value="ta-IN">üáÆüá≥ Tamil (India)</option>
                    <option value="te-IN">üáÆüá≥ Telugu (India)</option>
                    <option value="mr-IN">üáÆüá≥ Marathi (India)</option>
                    <option value="gu-IN">üáÆüá≥ Gujarati (India)</option>
                    <option value="kn-IN">üáÆüá≥ Kannada (India)</option>
                    <option value="ml-IN">üáÆüá≥ Malayalam (India)</option>
                    <option value="pa-IN">üáÆüá≥ Punjabi (India)</option>
                    <option value="ur-PK">üáµüá∞ Urdu (Pakistan)</option>
                    <option value="th-TH">üáπüá≠ Thai (Thailand)</option>
                    <option value="vi-VN">üáªüá≥ Vietnamese (Vietnam)</option>
                    <option value="id-ID">üáÆüá© Indonesian (Indonesia)</option>
                    <option value="ms-MY">üá≤üáæ Malay (Malaysia)</option>
                    <option value="tl-PH">üáµüá≠ Filipino (Philippines)</option>
                    
                    <!-- Middle Eastern & African Languages -->
                    <option value="ar-SA">üá∏üá¶ Arabic (Saudi Arabia)</option>
                    <option value="ar-EG">üá™üá¨ Arabic (Egypt)</option>
                    <option value="ar-AE">üá¶üá™ Arabic (UAE)</option>
                    <option value="he-IL">üáÆüá± Hebrew (Israel)</option>
                    <option value="fa-IR">üáÆüá∑ Persian (Iran)</option>
                    <option value="sw-KE">üá∞üá™ Swahili (Kenya)</option>
                    <option value="am-ET">üá™üáπ Amharic (Ethiopia)</option>
                    <option value="zu-ZA">üáøüá¶ Zulu (South Africa)</option>
                    <option value="af-ZA">üáøüá¶ Afrikaans (South Africa)</option>
                    
                    <!-- Other Languages -->
                    <option value="cy-GB">üè¥ÛêÅßÛêÅ¢ÛêÅ∑ÛêÅ¨ÛêÅ≥ÛêÅø Welsh (Wales)</option>
                    <option value="ga-IE">üáÆüá™ Irish (Ireland)</option>
                    <option value="mt-MT">üá≤üáπ Maltese (Malta)</option>
                    <option value="lv-LV">üá±üáª Latvian (Latvia)</option>
                    <option value="lt-LT">üá±üáπ Lithuanian (Lithuania)</option>
                    <option value="et-EE">üá™üá™ Estonian (Estonia)</option>
                    <option value="mk-MK">üá≤üá∞ Macedonian (North Macedonia)</option>
                    <option value="sq-AL">üá¶üá± Albanian (Albania)</option>
                    <option value="eu-ES">üè¥ÛêÅßÛêÅ¢ÛêÅ¢ÛêÅ°ÛêÅ≥ÛêÅø Basque (Spain)</option>
                    <option value="ca-ES">üè¥ÛêÅßÛêÅ¢ÛêÅ£ÛêÅ°ÛêÅ¥ÛêÅø Catalan (Spain)</option>
                    <option value="gl-ES">üè¥ÛêÅßÛêÅ¢ÛêÅßÛêÅ¨ÛêÅ£ÛêÅø Galician (Spain)</option>
                </select>
            </div>
            
            <div id="selected-language" style="margin-top: 15px; font-weight: bold; color: #2196f3;">
                No language selected
            </div>
        </div>
        
        <!-- Translation Display -->
        <div class="translation-container">
            <h3>üìñ Live Translation</h3>
            <div id="translation-display" class="translation-box">
                Waiting for teacher to start speaking...
            </div>
        </div>
        
        <!-- Audio Controls -->
        <div class="audio-controls">
            <button id="play-button" disabled>üîä Play Audio</button>
            <label for="volume-control">Volume:</label>
            <input type="range" id="volume-control" min="0" max="1" step="0.1" value="0.8">
        </div>
        
        <!-- Connection Controls -->
        <div class="controls">
            <button id="connect-btn">Connect to Session</button>
        </div>
    </div>

    <script>
        let ws = null;
        let selectedLanguage = null;
        let currentAudioData = null;
        let isConnected = false;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupLanguageSelection();
            
            // Check if classroom code is provided
            const urlParams = new URLSearchParams(window.location.search);
            const classroomCode = urlParams.get('code');
            
            if (!classroomCode) {
                // Show error message and disable functionality
                document.getElementById('connection-status').innerHTML = `
                    <div class="indicator disconnected"></div>
                    <span>No classroom code provided</span>
                `;
                document.getElementById('translation-display').innerHTML = 
                    '<div style="color: red; text-align: center; padding: 20px;">' +
                    '<h3>‚ùå Missing Classroom Code</h3>' +
                    '<p>Please get the correct link from your teacher.</p>' +
                    '<p>The link should look like: <code>/student?code=ABC123</code></p>' +
                    '</div>';
                document.getElementById('connect-btn').disabled = true;
                return;
            }
            
            // Show classroom code info
            const classroomInfo = document.createElement('div');
            classroomInfo.style.cssText = 'text-align: center; margin-bottom: 20px; padding: 10px; background: #e8f5e8; border-radius: 6px; border: 2px solid #28a745;';
            classroomInfo.innerHTML = `
                <div style="font-weight: bold; color: #28a745;">Joining Classroom: ${classroomCode}</div>
            `;
            document.querySelector('.container').insertBefore(classroomInfo, document.querySelector('h1').nextSibling);
            
            setupWebSocket();
            
            // Auto-select first language and enable button immediately
            setTimeout(() => {
                autoSelectFirstLanguage();
                document.getElementById('connect-btn').disabled = false;
            }, 100);
        });
        
        function autoSelectFirstLanguage() {
            const dropdown = document.getElementById('language-dropdown');
            if (dropdown && !selectedLanguage) {
                // Auto-select the first real option (not the placeholder)
                const firstOption = dropdown.options[1]; // Skip the placeholder at index 0
                if (firstOption) {
                    dropdown.value = firstOption.value;
                    selectedLanguage = firstOption.value;
                    
                    // Update display
                    const languageName = firstOption.textContent;
                    document.getElementById('selected-language').textContent = `Selected: ${languageName}`;
                    
                    // Enable connect button
                    document.getElementById('connect-btn').disabled = false;
                    
                    console.log('Auto-selected language:', selectedLanguage);
                }
            }
        }
        
        function setupLanguageSelection() {
            // Dropdown change handler
            const dropdown = document.getElementById('language-dropdown');
            dropdown.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                
                if (selectedOption.value) {
                    selectedLanguage = selectedOption.value;
                    
                    // Update display
                    const languageName = selectedOption.textContent;
                    document.getElementById('selected-language').textContent = `Selected: ${languageName}`;
                    
                    // Enable connect button
                    document.getElementById('connect-btn').disabled = false;
                    
                    // CRITICAL: Update WebSocket registration if connected
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const classroomCode = urlParams.get('code');
                        console.log('Language changed while connected - re-registering with server');
                        registerWithServer(classroomCode);
                    }
                    
                    console.log('Language selected:', selectedLanguage);
                } else {
                    // Placeholder selected
                    selectedLanguage = null;
                    document.getElementById('selected-language').textContent = 'No language selected';
                    document.getElementById('connect-btn').disabled = true;
                }
            });
        }
        
        function setupWebSocket() {
            document.getElementById('connect-btn').addEventListener('click', toggleConnection);
            document.getElementById('play-button').addEventListener('click', playCurrentAudio);
        }
        
        function toggleConnection() {
            if (isConnected) {
                disconnectFromServer();
            } else {
                connectToServer();
            }
        }
        
        function connectToServer() {
            // Check if there's a classroom code in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const classroomCode = urlParams.get('code');
            
            if (!classroomCode) {
                // No classroom code provided - show error
                updateStatus('No classroom code provided. Please get the link from your teacher.');
                return;
            }
            
            // Force enable even if no language detected
            if (!selectedLanguage) {
                console.log('No language selected, auto-selecting first option');
                autoSelectFirstLanguage();
            }
            
            // If still no language, use default
            if (!selectedLanguage) {
                selectedLanguage = 'es'; // Default to Spanish
                document.getElementById('selected-language').textContent = 'Selected: Spanish (Default)';
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws?class=${classroomCode}`;
            
            console.log('Connecting to WebSocket with classroom code:', classroomCode, 'and language:', selectedLanguage);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('Connected to server');
                updateConnectionStatus(true);
                registerWithServer(classroomCode);
            };
            
            ws.onmessage = function(event) {
                console.log('Received WebSocket message:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            ws.onclose = function() {
                console.log('Disconnected from server');
                updateConnectionStatus(false);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
        }
        
        function registerWithServer(classroomCode) {
            if (ws && ws.readyState === WebSocket.OPEN && selectedLanguage) {
                const message = {
                    type: 'register',
                    role: 'student',
                    languageCode: selectedLanguage,
                    classroomCode: classroomCode  // Include the classroom code
                };
                
                console.log('Sending registration:', message);
                ws.send(JSON.stringify(message));
                
                // Also send a ping to ensure the server knows we're active
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                    }
                }, 1000);
            }
        }
        
        function handleWebSocketMessage(data) {
            console.log('Processing message type:', data.type, data);
            
            switch (data.type) {
                case 'connection':
                    console.log('Connection confirmed:', data);
                    // Immediately register as student after connection
                    setTimeout(() => registerWithServer(), 100);
                    break;
                    
                case 'register':
                    if (data.status === 'success') {
                        console.log('Student registration successful:', data);
                    } else {
                        console.error('Student registration failed:', data);
                    }
                    break;
                    
                case 'translation':
                    console.log('Received translation:', data);
                    displayTranslation(data);
                    if (data.audioData) {
                        currentAudioData = data.audioData;
                        document.getElementById('play-button').disabled = false;
                        // Auto-play the audio
                        playAudio(data.audioData);
                    }
                    break;
                    
                case 'error':
                    console.error('Server error:', data.message);
                    // Also display error in translation area
                    const display = document.getElementById('translation-display');
                    display.innerHTML = `<div style="color: red;">Error: ${data.message}</div>`;
                    break;
                    
                default:
                    console.log('Unknown message type:', data.type, data);
                    // For debugging, try to display any message with text
                    if (data.text || data.translatedText || data.message) {
                        console.log('Attempting to display unknown message type as translation');
                        displayTranslation(data);
                    }
            }
        }
        
        function displayTranslation(data) {
            const display = document.getElementById('translation-display');
            
            // Handle different message formats from the server
            // Check all possible field names the server might be using
            const originalText = data.originalText || data.original || data.sourceText || 'Unknown';
            
            // The server might be sending translation in different fields
            let translatedText = 'No translation available';
            
            // Check multiple possible field names
            if (data.text) {
                translatedText = data.text;
            } else if (data.translatedText) {
                translatedText = data.translatedText;
            } else if (data.translated) {
                translatedText = data.translated;
            } else if (data.message) {
                translatedText = data.message;
            } else {
                console.warn('No translation text found in data object:', Object.keys(data));
            }
            
            display.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Original:</strong> ${originalText}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Translation:</strong> ${translatedText}
                </div>
            `;
        }
        
        function playAudio(audioBase64) {
            try {
                console.log('Playing audio, data length:', audioBase64.length);
                const audio = new Audio(`data:audio/mp3;base64,${audioBase64}`);
                audio.volume = document.getElementById('volume-control').value;
                
                audio.onloadeddata = function() {
                    console.log('Audio loaded successfully');
                };
                
                audio.onerror = function(e) {
                    console.error('Audio play error:', e);
                };
                
                audio.play().catch(e => {
                    console.error('Audio play failed:', e);
                    // Show user-friendly message
                    const display = document.getElementById('translation-display');
                    display.innerHTML += '<br><em style="color: #ff6b6b;">Click the play button to hear audio</em>';
                });
            } catch (error) {
                console.error('Error creating audio:', error);
            }
        }
        
        function playCurrentAudio() {
            if (currentAudioData) {
                playAudio(currentAudioData);
            } else {
                console.log('No audio data available to play');
            }
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            const indicator = status.querySelector('.indicator');
            const text = status.querySelector('span');
            const connectBtn = document.getElementById('connect-btn');
            
            isConnected = connected;
            
            if (connected) {
                status.className = 'status connected';
                indicator.className = 'indicator connected';
                text.textContent = 'Connected';
                connectBtn.textContent = 'Disconnect';
                connectBtn.className = 'connected';
                connectBtn.disabled = false;
            } else {
                status.className = 'status disconnected';
                indicator.className = 'indicator disconnected';
                text.textContent = 'Disconnected';
                connectBtn.textContent = 'Connect to Session';
                connectBtn.className = '';
                // Only enable connect button if language is selected
                connectBtn.disabled = !selectedLanguage;
                document.getElementById('play-button').disabled = true;
            }
        }
        
        function disconnectFromServer() {
            if (ws) {
                ws.close();
            }
        }
    </script>
</body>
</html>
