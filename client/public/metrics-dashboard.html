<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIVoiceTranslator - Metrics Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <style>
    :root {
      --primary-color: #4a86e8;
      --success-color: #34a853;
      --warning-color: #fbbc05;
      --danger-color: #ea4335;
      --neutral-color: #5f6368;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
      color: #202124;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .card {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      border: none;
      overflow: hidden;
    }
    
    .card-header {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .metric-tile {
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      background-color: white;
    }
    
    .metric-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--neutral-color);
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .metric-subtitle {
      font-size: 12px;
      color: var(--neutral-color);
    }
    
    .progress {
      height: 8px;
      margin-top: 10px;
      border-radius: 4px;
    }
    
    .badge {
      font-size: 0.8em;
      padding: 5px 10px;
      border-radius: 12px;
    }
    
    .badge-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .badge-warning {
      background-color: var(--warning-color);
      color: white;
    }
    
    .badge-danger {
      background-color: var(--danger-color);
      color: white;
    }
    
    .refresh-button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    
    .refresh-button:hover {
      background-color: #3a76d8;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table thead th {
      background-color: #f1f3f4;
      font-weight: 600;
      border-top: none;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary-color);
    }
    
    .workflow-status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-success {
      background-color: var(--success-color);
    }
    
    .status-failure, .status-failed {
      background-color: var(--danger-color);
    }
    
    .status-pending, .status-in_progress {
      background-color: var(--warning-color);
    }
    
    .status-unknown {
      background-color: var(--neutral-color);
    }
    
    .chart-container {
      height: 200px;
      margin-top: 15px;
    }
    
    @media (max-width: 768px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>AIVoiceTranslator Metrics</h1>
      <p class="text-muted">Comprehensive quality and testing metrics dashboard</p>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>Testing Metrics</h2>
      <button id="refreshButton" class="refresh-button">
        <i class="bi bi-arrow-clockwise"></i> Refresh Metrics
      </button>
    </div>
    
    <div class="row mb-4">
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-header">Unit Tests</div>
          <div class="card-body">
            <div class="metric-value" id="unitTestsPassed">0/0</div>
            <div class="progress">
              <div id="unitTestsProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span>Pass Rate</span>
              <span id="unitTestsPassRate">0%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-header">Integration Tests</div>
          <div class="card-body">
            <div class="metric-value" id="integrationTestsPassed">0/0</div>
            <div class="progress">
              <div id="integrationTestsProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span>Pass Rate</span>
              <span id="integrationTestsPassRate">0%</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-header">End-to-End Tests</div>
          <div class="card-body">
            <div class="metric-value" id="e2eTestsPassed">0/0</div>
            <div class="progress">
              <div id="e2eTestsProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
              <span>Pass Rate</span>
              <span id="e2eTestsPassRate">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header">Audio Testing Metrics</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="metric-title">Audio Test Status</div>
                <div class="d-flex align-items-center">
                  <div id="audioTestStatus" class="workflow-status status-unknown"></div>
                  <div id="audioTestStatusText">Unknown</div>
                </div>
                <div class="metric-subtitle" id="audioTestLastRun">Last run: N/A</div>
              </div>
              <div class="col-md-6">
                <div class="metric-title">Pass Rate</div>
                <div class="metric-value" id="audioTestsPassed">0/0</div>
                <div class="progress">
                  <div id="audioTestsProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-header">CI/CD Pipeline Status</div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="metric-title">Pipeline Status</div>
                <div class="d-flex align-items-center">
                  <div id="cicdStatus" class="workflow-status status-unknown"></div>
                  <div id="cicdStatusText">Unknown</div>
                </div>
                <div class="metric-subtitle" id="cicdLastRun">Last run: N/A</div>
              </div>
              <div class="col-md-6">
                <div class="metric-title">Recent Workflows</div>
                <div id="workflowCount" class="metric-value">0</div>
                <div class="metric-subtitle">View details below</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card mb-4">
      <div class="card-header">Recent Workflow Runs</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Last Run</th>
                <th>Duration</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="workflowTableBody">
              <tr>
                <td colspan="5" class="text-center">No workflow data available</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="card mb-4">
      <div class="card-header">Code Quality Metrics</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-3">
            <div class="metric-title">Coverage</div>
            <div class="metric-value" id="coverageValue">0%</div>
            <div class="progress">
              <div id="coverageProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="metric-title">Code Smells</div>
            <div class="metric-value" id="codeSmellsValue">0</div>
            <div class="progress">
              <div id="codeSmellsProgressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="metric-title">Duplication</div>
            <div class="metric-value" id="duplicationValue">0%</div>
            <div class="progress">
              <div id="duplicationProgressBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Configuration
    const API_BASE_URL = '/api';
    
    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const refreshButton = document.getElementById('refreshButton');
    const workflowTableBody = document.getElementById('workflowTableBody');
    
    // Test elements
    const unitTestsPassed = document.getElementById('unitTestsPassed');
    const unitTestsProgressBar = document.getElementById('unitTestsProgressBar');
    const unitTestsPassRate = document.getElementById('unitTestsPassRate');
    
    const integrationTestsPassed = document.getElementById('integrationTestsPassed');
    const integrationTestsProgressBar = document.getElementById('integrationTestsProgressBar');
    const integrationTestsPassRate = document.getElementById('integrationTestsPassRate');
    
    const e2eTestsPassed = document.getElementById('e2eTestsPassed');
    const e2eTestsProgressBar = document.getElementById('e2eTestsProgressBar');
    const e2eTestsPassRate = document.getElementById('e2eTestsPassRate');
    
    // Audio test elements
    const audioTestStatus = document.getElementById('audioTestStatus');
    const audioTestStatusText = document.getElementById('audioTestStatusText');
    const audioTestLastRun = document.getElementById('audioTestLastRun');
    const audioTestsPassed = document.getElementById('audioTestsPassed');
    const audioTestsProgressBar = document.getElementById('audioTestsProgressBar');
    
    // CI/CD elements
    const cicdStatus = document.getElementById('cicdStatus');
    const cicdStatusText = document.getElementById('cicdStatusText');
    const cicdLastRun = document.getElementById('cicdLastRun');
    const workflowCount = document.getElementById('workflowCount');
    
    // Code quality elements
    const coverageValue = document.getElementById('coverageValue');
    const coverageProgressBar = document.getElementById('coverageProgressBar');
    const codeSmellsValue = document.getElementById('codeSmellsValue');
    const codeSmellsProgressBar = document.getElementById('codeSmellsProgressBar');
    const duplicationValue = document.getElementById('duplicationValue');
    const duplicationProgressBar = document.getElementById('duplicationProgressBar');
    
    /**
     * Fetch metrics data from the API
     */
    async function fetchMetrics() {
      try {
        showLoading();
        
        // Fetch test results
        const testResults = await fetch(`${API_BASE_URL}/metrics/test-results`).then(res => res.json());
        
        // Fetch code quality metrics
        const codeQuality = await fetch(`${API_BASE_URL}/metrics`).then(res => res.json());
        
        hideLoading();
        
        // Update the UI with the fetched metrics
        updateTestMetrics(testResults);
        updateCodeQualityMetrics(codeQuality);
        updateAudioMetrics(testResults.audio);
        updateCICDMetrics(testResults.cicd);
        
        return { testResults, codeQuality };
      } catch (error) {
        console.error('Error fetching metrics:', error);
        hideLoading();
        showError('Failed to fetch metrics data. Please try again later.');
        return null;
      }
    }
    
    /**
     * Update the test metrics UI
     */
    function updateTestMetrics(testResults) {
      if (!testResults) return;
      
      // Unit tests
      const unitPassRate = testResults.unit.total > 0 ? 
        Math.round((testResults.unit.passed / testResults.unit.total) * 100) : 0;
      
      unitTestsPassed.textContent = `${testResults.unit.passed}/${testResults.unit.total}`;
      unitTestsProgressBar.style.width = `${unitPassRate}%`;
      unitTestsPassRate.textContent = `${unitPassRate}%`;
      
      // Integration tests
      const integrationPassRate = testResults.integration.total > 0 ? 
        Math.round((testResults.integration.passed / testResults.integration.total) * 100) : 0;
      
      integrationTestsPassed.textContent = `${testResults.integration.passed}/${testResults.integration.total}`;
      integrationTestsProgressBar.style.width = `${integrationPassRate}%`;
      integrationTestsPassRate.textContent = `${integrationPassRate}%`;
      
      // E2E tests
      const e2ePassRate = testResults.e2e.total > 0 ? 
        Math.round((testResults.e2e.passed / testResults.e2e.total) * 100) : 0;
      
      e2eTestsPassed.textContent = `${testResults.e2e.passed}/${testResults.e2e.total}`;
      e2eTestsProgressBar.style.width = `${e2ePassRate}%`;
      e2eTestsPassRate.textContent = `${e2ePassRate}%`;
    }
    
    /**
     * Update the audio metrics UI
     */
    function updateAudioMetrics(audioMetrics) {
      if (!audioMetrics) return;
      
      // Audio test status
      audioTestStatus.className = `workflow-status status-${audioMetrics.passed === audioMetrics.total ? 'success' : 'warning'}`;
      audioTestStatusText.textContent = audioMetrics.passed === audioMetrics.total ? 'Passing' : 'Partially Passing';
      
      // Audio test last run
      const lastRunDate = new Date(audioMetrics.lastRun);
      audioTestLastRun.textContent = `Last run: ${lastRunDate.toLocaleString()}`;
      
      // Audio test pass rate
      const audioPassRate = audioMetrics.total > 0 ? 
        Math.round((audioMetrics.passed / audioMetrics.total) * 100) : 0;
      
      audioTestsPassed.textContent = `${audioMetrics.passed}/${audioMetrics.total}`;
      audioTestsProgressBar.style.width = `${audioPassRate}%`;
    }
    
    /**
     * Update the CI/CD metrics UI
     */
    function updateCICDMetrics(cicdMetrics) {
      if (!cicdMetrics) return;
      
      // CI/CD status
      cicdStatus.className = `workflow-status status-${cicdMetrics.status === 'success' ? 'success' : cicdMetrics.status === 'failure' || cicdMetrics.status === 'failed' ? 'failure' : 'unknown'}`;
      cicdStatusText.textContent = cicdMetrics.status === 'success' ? 'Successful' : cicdMetrics.status === 'failure' || cicdMetrics.status === 'failed' ? 'Failed' : 'Unknown';
      
      // CI/CD last run
      const lastRunDate = new Date(cicdMetrics.lastRun);
      cicdLastRun.textContent = `Last run: ${lastRunDate.toLocaleString()}`;
      
      // Workflow count
      const workflows = cicdMetrics.workflows || [];
      workflowCount.textContent = workflows.length;
      
      // Update workflow table
      updateWorkflowTable(workflows);
    }
    
    /**
     * Update the workflow table with recent workflow runs
     */
    function updateWorkflowTable(workflows) {
      if (!workflows || workflows.length === 0) {
        workflowTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No workflow data available</td></tr>';
        return;
      }
      
      const tableRows = workflows.map(workflow => {
        return `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <div class="workflow-status status-${workflow.status === 'success' ? 'success' : workflow.status === 'failure' || workflow.status === 'failed' ? 'failure' : workflow.status === 'pending' || workflow.status === 'in_progress' ? 'pending' : 'unknown'}"></div>
                ${workflow.status}
              </div>
            </td>
            <td>${workflow.name}</td>
            <td>${new Date(workflow.lastRun).toLocaleString()}</td>
            <td>${workflow.duration}</td>
            <td>
              ${workflow.url ? `<a href="${workflow.url}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>` : 'N/A'}
            </td>
          </tr>
        `;
      }).join('');
      
      workflowTableBody.innerHTML = tableRows;
    }
    
    /**
     * Update the code quality metrics UI
     */
    function updateCodeQualityMetrics(metrics) {
      if (!metrics || !metrics.coverage || !metrics.codeSmells || !metrics.duplication) return;
      
      // Coverage
      coverageValue.textContent = `${metrics.coverage.overall}%`;
      coverageProgressBar.style.width = `${metrics.coverage.overall}%`;
      
      // Code smells
      codeSmellsValue.textContent = metrics.codeSmells.total;
      // For code smells, less is better, so we invert the scale (max 50 smells)
      const smellsPercentage = Math.max(0, 100 - (metrics.codeSmells.total * 2));
      codeSmellsProgressBar.style.width = `${smellsPercentage}%`;
      
      // Duplication
      duplicationValue.textContent = `${metrics.duplication.percentage}%`;
      // For duplication, less is better, so we invert the scale
      const duplicationPercentage = Math.max(0, 100 - metrics.duplication.percentage * 4);
      duplicationProgressBar.style.width = `${duplicationPercentage}%`;
    }
    
    /**
     * Show error message
     */
    function showError(message) {
      alert(message); // Simple error display for now
    }
    
    /**
     * Show loading overlay
     */
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }
    
    /**
     * Hide loading overlay
     */
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }
    
    // Event Listeners
    refreshButton.addEventListener('click', fetchMetrics);
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', fetchMetrics);
  </script>
</body>
</html>