/**
 * DATABASE & STORAGE ARCHITECTURE OVERVIEW
 * ========================================
 * 
 * This document explains the database and storage system organization
 * to help you understand "what's what" in this project.
 */

## CORE STORAGE SYSTEM

### 1. Main Storage Implementation (`server/storage.ts`)
- **IStorage Interface**: Contract defining all storage operations
- **MemStorage Class**: In-memory storage (currently active, no database needed)
- **DatabaseStorage Class**: PostgreSQL implementation (available but not used)
- **Export**: `storage = new MemStorage()` - this is what the app uses

### 2. Database Connection (`server/db.ts`)
- Sets up PostgreSQL connection using Drizzle ORM with multi-provider support (Aiven/Railway)
- Exports `db` (database client) and `pool` (connection pool)
- Only needed if you switch to DatabaseStorage

### 3. Database Schema (`shared/schema.ts`)
- Defines table structures: users, languages, translations, transcripts
- Uses Drizzle ORM with PostgreSQL types
- Shared between client and server

## CURRENT STATE
- **Active Storage**: MemStorage (in-memory, no database required)
- **Database Ready**: DatabaseStorage implemented but not used
- **Switch Method**: Change `export const storage = new MemStorage()` to `new DatabaseStorage()`

## TESTING STRUCTURE

### Unit Tests
- `tests/unit/storage.test.ts` - Main comprehensive test suite
- Tests both MemStorage and DatabaseStorage (DatabaseStorage tests mocked)

### Integration Tests  
- `tests/integration/storage/DatabaseStorage-integration.test.ts`
- Tests DatabaseStorage with real database (currently skipped)
- Requires DATABASE_URL environment variable

### Test Utilities
- `tests/setup/db-setup.ts` - Database setup/teardown for integration tests (may need review with new migration flow).
- `db-migration-scripts/`: Contains TypeScript scripts for database operations:
    - `migrate.ts`: Applies pending migrations to the development database (uses `.env`).
    - `migrate-test.ts`: Applies pending migrations to the test database (uses `.env.test`).
    - `reset-db.ts`: Drops tables from the development database.
    - `reset-db-test.ts`: Drops tables from the test database.
- `server/test-db.ts` - [Obsolete] This file is no longer used.

## CONFIGURATION FILES
- `config/drizzle.config.ts` - Drizzle ORM configuration used by `drizzle-kit` to generate migration files. It specifies the schema location and output directory for migrations.
- `.env`: Contains `DATABASE_URL` for the development database.
- `.env.test`: Contains `DATABASE_URL` for the test database.

## DATABASE MIGRATIONS
- **Migration Files**: Located in the `migrations/` folder. These are SQL files auto-generated by Drizzle Kit based on changes to `shared/schema.ts`. They represent versioned changes to the database schema.
- **Migration Scripts**: Located in `db-migration-scripts/`. These are custom scripts to apply migrations or reset databases.

## HOW TO USE

### Current Setup (No Database / Memory Storage)
```javascript
// Already working - uses MemStorage if STORAGE_TYPE=memory (default)
import { storage } from './server/storage';
await storage.getLanguages(); // Works immediately
```

### Using Database Storage (Development & Test)

1.  **Environment Variables:**
    *   Set `STORAGE_TYPE=database` in your `.env` file (for development).
    *   Ensure `DATABASE_URL` in `.env` points to your development PostgreSQL database.
    *   Ensure `DATABASE_URL` in `.env.test` points to your test PostgreSQL database.

2.  **Initial Database Setup / Schema Updates:**
    *   **Modify Schema:** If making changes, edit `shared/schema.ts`.
    *   **Generate Migrations:**
        ```bash
        npm run db:migrations:generate
        ```
        This creates/updates SQL files in the `migrations/` folder.
    *   **Apply to Development Database:**
        ```bash
        npm run db:migrations:apply
        ```
    *   **Apply to Test Database:**
        ```bash
        npm run db:migrations:apply:test
        ```

3.  **Switch `storage.ts` (if not already done):**
    Ensure `server/storage.ts` is configured to use `DatabaseStorage` when `STORAGE_TYPE=database`. (The current implementation in `storage.ts` should handle this based on `process.env.STORAGE_TYPE`).

4.  **Restart Application:**
    ```bash
    npm run dev
    ```

### Resetting Databases (Caution: Deletes Data!)
*   To reset the development database:
    ```bash
    npm run db:reset
    npm run db:migrations:apply
    ```
*   To reset the test database:
    ```bash
    npm run db:reset:test 
    # OR npm run db-test:reset
    npm run db:migrations:apply:test
    ```

### Production Database Setup (TODO)

*   **TODO:** When setting up a dedicated production database:
    1.  Create the production database instance (Railway for production, Aiven for dev/CI/CD, Aiven for local/test).
    2.  Configure its `DATABASE_URL` securely in your production environment.
    3.  Deploy your application code, including the `migrations/` directory and `db-migration-scripts/migrate.ts`.
    4.  In your production deployment process, execute the command to apply migrations:
        ```bash
        # Example: In production environment
        npm run db:migrations:apply 
        ```
        (This assumes `db:migrations:apply` is available and configured to use the production `DATABASE_URL`).
    5.  **Important:** Avoid using `db:reset` or `drizzle-kit push` (via `npm run db:push`) on a live production database unless data loss is intended and acceptable. Always prefer the versioned migration workflow (`db:migrations:apply`).

### Run Tests
```bash
npm test                    # Unit tests (fast, no database needed)
npm run test:integration   # Integration tests (requires database)
```

## CLEANUP COMPLETED
- Removed duplicate test files
- Consolidated into single comprehensive test suite
- Clear separation between unit and integration tests