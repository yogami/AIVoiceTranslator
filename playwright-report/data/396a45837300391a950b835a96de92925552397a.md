# Test info

- Name: Analytics Dashboard E2E Tests >> should handle API errors gracefully
- Location: /Users/yamijala/gitprojects/AIVoiceTranslator/tests/e2e/diagnostics.spec.ts:157:3

# Error details

```
Error: Timed out 5000ms waiting for expect(locator).toBeVisible()

Locator: locator('.error-message')
Expected: visible
Received: <element(s) not found>
Call log:
  - expect.toBeVisible with timeout 5000ms
  - waiting for locator('.error-message')

    at /Users/yamijala/gitprojects/AIVoiceTranslator/tests/e2e/diagnostics.spec.ts:172:32
```

# Page snapshot

```yaml
- heading "Analytics Dashboard" [level=1]
- link "â† Back to Home":
  - /url: /
- paragraph: Real-time usage metrics and adoption analytics for AI Voice Translator
- button "ðŸ”„ Refresh Data"
- button "ðŸ“¥ Export Data"
- 'button "â° Auto-refresh: OFF"'
- combobox:
  - option "Last 24 Hours" [selected]
  - option "Last 7 Days"
  - option "Last 30 Days"
  - option "All Time"
- text: "Displaying metrics for: Last 24 Hours"
- heading "ðŸ“Š Product Adoption Metrics" [level=2]
- paragraph: Key metrics for understanding product usage and growth
- heading "Total Sessions" [level=3]
- text: All-time Sessions 1 Active Now 0 Average Duration 1.4 minutes
- heading "Active Users" [level=3]
- text: Teachers Online 0 Students Online 0 Languages in Use 0
- heading "Translation Volume" [level=3]
- text: Total Translations 0 Last Hour 0 Average Latency 0 ms
- heading "ðŸ“ˆ Usage Analytics" [level=2]
- paragraph: Translation volume and language pair popularity
- text: No language pair data available yet
- heading "âš¡ Performance & Quality Metrics" [level=2]
- paragraph: Technical metrics for monitoring system health and performance
- heading "System Health" [level=3]
- text: Uptime 3.4 minutes Memory Usage 22.0 MB Active Connections 0
- heading "Audio Generation" [level=3]
- text: Total Generated 0 Average Time 0 ms Cache Size 0.0 B
- heading "Real-time Performance" [level=3]
- text: Active Translations 0 Average Latency 0 ms Total Connections 0
- heading "ðŸ• Recent Session Activity" [level=2]
- paragraph: Latest classroom sessions and their activity
- heading "Recent Sessions" [level=3]
- text: "session-1-1749662907103 Language: English (US) 0 transcripts Duration: 1m 26s Last: 7:29:53 PM Last updated: 6/11/2025, 7:31:31 PM"
```

# Test source

```ts
   72 |     await expect(page.locator('.metric-card:has-text("Total Sessions")')).toBeVisible();
   73 |     await expect(page.locator('.metric-card:has-text("Active Users")')).toBeVisible();
   74 |     await expect(page.locator('.metric-card:has-text("Translation Volume")')).toBeVisible();
   75 |     await expect(page.locator('.metric-card:has-text("System Health")')).toBeVisible();
   76 |     await expect(page.locator('.metric-card:has-text("Audio Generation")')).toBeVisible();
   77 |     await expect(page.locator('.metric-card:has-text("Real-time Performance")')).toBeVisible();
   78 |   });
   79 |
   80 |   test('should refresh data when refresh button is clicked', async () => {
   81 |     // Wait for initial load
   82 |     await page.waitForSelector('#last-updated', { timeout: 5000 });
   83 |     
   84 |     // Get initial last updated time
   85 |     const lastUpdated = page.locator('#last-updated');
   86 |     const initialTime = await lastUpdated.textContent();
   87 |     
   88 |     // Click refresh button
   89 |     await page.click('#refresh-btn');
   90 |     
   91 |     // Wait a moment for the refresh to process
   92 |     await page.waitForTimeout(500);
   93 |     
   94 |     // Check that last updated time exists
   95 |     const newTime = await lastUpdated.textContent();
   96 |       expect(newTime).toContain('Last updated:');
   97 |   });
   98 |
   99 |   test('should toggle auto-refresh', async () => {
  100 |     const autoRefreshBtn = page.locator('#auto-refresh-btn');
  101 |     
  102 |     // Initially should be OFF
  103 |     await expect(autoRefreshBtn).toContainText('â° Auto-refresh: OFF');
  104 |     
  105 |     // Click to enable
  106 |     await autoRefreshBtn.click();
  107 |     
  108 |     // Check for 'Enabled' state text or class if available, e.g.,
  109 |     // await expect(page.locator('#auto-refresh-status')).toHaveText('Auto-Refresh: Enabled');
  110 |     
  111 |     // Re-fetch background color after click
  112 |     let bgColor = await autoRefreshBtn.evaluate(element => getComputedStyle(element).backgroundColor);
  113 |     // Check if it's a green color (allowing for browser differences)
  114 |     expect(bgColor).toMatch(/rgb\(4[67], (20[0-9]), (11[0-9])\)/); // Corrected regex for green and blue components
  115 |
  116 |     // Click to disable
  117 |     await autoRefreshBtn.click();
  118 |     await expect(autoRefreshBtn).toContainText('â° Auto-refresh: OFF');
  119 |   });
  120 |
  121 |   test('should export data when export button is clicked', async () => {
  122 |     // Set up download promise before clicking
  123 |     const downloadPromise = page.waitForEvent('download');
  124 |     
  125 |     // Click export button
  126 |     await page.click('#export-btn');
  127 |     
  128 |     // Wait for download
  129 |     const download = await downloadPromise;
  130 |     
  131 |     // Verify download
  132 |     expect(download.suggestedFilename()).toMatch(/analytics-export-\d{4}-\d{2}-\d{2}\.json/);
  133 |   });
  134 |
  135 |   test('should display language pair metrics table or no data message', async () => {
  136 |     // Wait for usage analytics section to load
  137 |     await page.waitForSelector('#usage-analytics', { timeout: 5000 });
  138 |     
  139 |     // Check if table exists or no data message is shown
  140 |     const tableExists = await page.locator('.language-pairs-table').count() > 0;
  141 |     const noDataExists = await page.locator('.no-data').count() > 0;
  142 |     
  143 |     // Either table or no data message should be present
  144 |     expect(tableExists || noDataExists).toBeTruthy();
  145 |     
  146 |     if (tableExists) {
  147 |       // Check table headers
  148 |       const headers = page.locator('.language-pairs-table th');
  149 |       await expect(headers).toHaveCount(4);
  150 |       await expect(headers.nth(0)).toContainText('Source Language');
  151 |       await expect(headers.nth(1)).toContainText('Target Language');
  152 |       await expect(headers.nth(2)).toContainText('Translation Count');
  153 |       await expect(headers.nth(3)).toContainText('Average Latency');
  154 |     }
  155 |   });
  156 |
  157 |   test('should handle API errors gracefully', async () => {
  158 |     // Intercept API call and return error
  159 |     await page.route('/api/diagnostics', route => {
  160 |       route.fulfill({
  161 |         status: 500,
  162 |         contentType: 'application/json',
  163 |         body: JSON.stringify({ error: 'Internal Server Error' })
  164 |       });
  165 |     });
  166 |     
  167 |     // Reload page
  168 |     await page.reload();
  169 |     
  170 |     // Should show error message
  171 |     const errorMessage = page.locator('.error-message');
> 172 |     await expect(errorMessage).toBeVisible();
      |                                ^ Error: Timed out 5000ms waiting for expect(locator).toBeVisible()
  173 |     await expect(errorMessage).toContainText('Failed to load diagnostics');
  174 |   });
  175 |
  176 |   test('should display formatted metrics correctly', async () => {
  177 |     // Wait for metrics to load
  178 |     await page.waitForSelector('.metric-value', { timeout: 5000 });
  179 |     
  180 |     // Check that metrics are formatted
  181 |     const metricValues = page.locator('.metric-value');
  182 |     const count = await metricValues.count();
  183 |     
  184 |     // At least some metrics should be displayed
  185 |     expect(count).toBeGreaterThan(0);
  186 |     
  187 |     // Check specific formatting
  188 |     const firstValue = await metricValues.first().textContent();
  189 |     expect(firstValue).toBeTruthy();
  190 |   });
  191 |
  192 |   test('should navigate back to home', async () => {
  193 |     // Click back to home link
  194 |     await page.click('a:has-text("Back to Home")');
  195 |     
  196 |     // Should navigate to home page
  197 |     await expect(page).toHaveURL('/');
  198 |   });
  199 |
  200 |   test('should be responsive on mobile', async () => {
  201 |     // Set mobile viewport
  202 |     await page.setViewportSize({ width: 375, height: 667 });
  203 |     
  204 |     // Check that layout adapts - use first metrics grid
  205 |     const metricsGrid = page.locator('.metrics-grid').first();
  206 |     const gridStyle = await metricsGrid.evaluate((el: HTMLElement) => 
  207 |       window.getComputedStyle(el).gridTemplateColumns
  208 |     );
  209 |     
  210 |     // Should be single column on mobile (either '1fr' or a single pixel value)
  211 |     const isSingleColumn = gridStyle === '1fr' || 
  212 |                           (gridStyle.match(/^\d+px$/) !== null && !gridStyle.includes(' '));
  213 |     expect(isSingleColumn).toBeTruthy();
  214 |     
  215 |     // Buttons should stack vertically
  216 |     const controls = page.locator('.controls');
  217 |     const controlsStyle = await controls.evaluate((el: HTMLElement) => 
  218 |       window.getComputedStyle(el).flexDirection
  219 |     );
  220 |     expect(controlsStyle).toBe('column');
  221 |   });
  222 |
  223 |   test('should display recent session activity', async () => {
  224 |     // Wait for recent activity section
  225 |     await page.waitForSelector('#recent-activity', { timeout: 10000 }); // Increased timeout
  226 |     
  227 |     const recentActivity = page.locator('#recent-activity');
  228 |     const content = await recentActivity.textContent();
  229 |     
  230 |     // Should either show sessions or "no data" message
  231 |     expect(content).toMatch(/Recent Sessions|No recent session activity/);
  232 |   });
  233 |
  234 |   test('should update metrics in real-time when auto-refresh is enabled', async () => {
  235 |     // Enable auto-refresh
  236 |     await page.click('#auto-refresh-btn');
  237 |     
  238 |     // Get initial last updated time
  239 |     const lastUpdated = page.locator('#last-updated');
  240 |     const initialTime = await lastUpdated.textContent();
  241 |     
  242 |     // Wait for auto-refresh (5 seconds + buffer)
  243 |     await page.waitForTimeout(6000);
  244 |     
  245 |     // Check that last updated time exists (may or may not have changed in test environment)
  246 |     const updatedTime = await lastUpdated.textContent();
  247 |     expect(updatedTime).toContain('Last updated:');
  248 |   });
  249 |
  250 |   test('should display connection metrics correctly', async () => {
  251 |     // Wait for metrics to load
  252 |     await page.waitForSelector('.metric-card', { timeout: 5000 });
  253 |     
  254 |     // Find the Active Users card which contains connection info
  255 |     const activeUsersCard = page.locator('.metric-card:has-text("Active Users")');
  256 |     await expect(activeUsersCard).toBeVisible();
  257 |     
  258 |     // Check that it contains connection-related metrics
  259 |     await expect(activeUsersCard).toContainText('Teachers Online');
  260 |     await expect(activeUsersCard).toContainText('Students Online');
  261 |     await expect(activeUsersCard).toContainText('Languages in Use');
  262 |   });
  263 |
  264 |   test('should display session metrics correctly', async () => {
  265 |     // Wait for metrics to load
  266 |     await page.waitForSelector('.metric-card', { timeout: 5000 });
  267 |     
  268 |     // Find the Total Sessions card
  269 |     const sessionsCard = page.locator('.metric-card:has-text("Total Sessions")');
  270 |     await expect(sessionsCard).toBeVisible();
  271 |     
  272 |     // Check that it contains session-related metrics
```